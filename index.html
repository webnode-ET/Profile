import os
import sqlite3
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor
from dotenv import load_dotenv
from config import BOT_TOKEN, UPLOAD_FOLDER, LANGUAGES
from messages import MESSAGES

load_dotenv()
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

# User language storage (in-memory, can upgrade to DB later)
user_lang = {}

# Helper: ensure directory exists
def ensure_dir(path):
    if not os.path.exists(path):
        os.makedirs(path)

ensure_dir(UPLOAD_FOLDER)

# --- DATABASE SETUP ---
conn = sqlite3.connect("db.sqlite")
cursor = conn.cursor()
cursor.execute("""
CREATE TABLE IF NOT EXISTS events(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT,
    description TEXT,
    date TEXT,
    time TEXT,
    location TEXT,
    gps_lat REAL,
    gps_long REAL,
    invitation_photo TEXT,
    schedule TEXT
)
""")
cursor.execute("""
CREATE TABLE IF NOT EXISTS rsvps(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    event_id INTEGER,
    guest_name TEXT,
    attendees INTEGER,
    comments TEXT,
    file_path TEXT
)
""")
conn.commit()
conn.close()

# --- COMMANDS ---

# Start command
@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    text = MESSAGES["start"]["en"] + "\n" + MESSAGES["choose_language"]["en"]
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add("English", "Amharic")
    await message.answer(text, reply_markup=keyboard)

# Language selection
@dp.message_handler(lambda message: message.text in ["English", "Amharic"])
async def choose_language(message: types.Message):
    lang = "en" if message.text == "English" else "am"
    user_lang[message.from_user.id] = lang
    await message.answer("Language set." if lang=="en" else "ቋንቋ ተለዋዋጭ ሆነ።", reply_markup=types.ReplyKeyboardRemove())

# Admin: Create event
@dp.message_handler(commands=['create_event'])
async def create_event(message: types.Message):
    lang = user_lang.get(message.from_user.id, "en")
    await message.answer(
        "Send event details in this format:\nTitle|Description|Date|Time|Location|GPS_Lat|GPS_Long|Schedule"
        if lang=="en" else
        "ዝርዝሩን በዚህ ቅርጽ ይላኩ፦\nርዕስ|መግለጫ|ቀን|ሰዓት|ቦታ|GPS_Lat|GPS_Long|Schedule"
    )

# Save event
@dp.message_handler(lambda message: "|" in message.text)
async def save_event(message: types.Message):
    parts = message.text.split("|")
    lang = user_lang.get(message.from_user.id, "en")
    if len(parts) != 8:
        await message.answer(MESSAGES["incorrect_format"][lang])
        return
    conn = sqlite3.connect("db.sqlite")
    cursor = conn.cursor()
    cursor.execute("""
    INSERT INTO events(title,description,date,time,location,gps_lat,gps_long,schedule)
    VALUES(?,?,?,?,?,?,?,?)
    """, (parts[0], parts[1], parts[2], parts[3], parts[4], parts[5], parts[6], parts[7]))
    conn.commit()
    conn.close()
    await message.answer(MESSAGES["event_created"][lang].format(title=parts[0]))

# Admin: Upload invitation photo
@dp.message_handler(commands=['upload_photo'])
async def upload_photo(message: types.Message):
    parts = message.text.split()
    lang = user_lang.get(message.from_user.id, "en")
    if len(parts)!=2 or not parts[1].isdigit():
        await message.answer("Usage: /upload_photo <event_id>" if lang=="en" else "/upload_photo <event_id> ይጠቀሙ")
        return
    event_id = int(parts[1])
    await message.answer("Send the invitation photo.")

    @dp.message_handler(content_types=['photo'])
    async def photo_handler(msg: types.Message):
        photo = msg.photo[-1]
        path = os.path.join(UPLOAD_FOLDER, f"event_{event_id}_invitation.jpg")
        await photo.download(destination_file=path)
        conn = sqlite3.connect("db.sqlite")
        cursor = conn.cursor()
        cursor.execute("UPDATE events SET invitation_photo=? WHERE id=?", (path, event_id))
        conn.commit()
        conn.close()
        await msg.answer(MESSAGES["photo_uploaded"][lang])

# List events
@dp.message_handler(commands=['events'])
async def list_events(message: types.Message):
    lang = user_lang.get(message.from_user.id, "en")
    conn = sqlite3.connect("db.sqlite")
    cursor = conn.cursor()
    cursor.execute("SELECT id,title,date,time,location FROM events")
    events = cursor.fetchall()
    if not events:
        await message.answer(MESSAGES["no_events"][lang])
    else:
        msg = ""
        for e in events:
            msg += f"{e[0]}. {e[1]} | {e[2]} {e[3]} | {e[4]}\n"
        await message.answer(msg)
    conn.close()

# Map location
@dp.message_handler(commands=['map'])
async def map_event(message: types.Message):
    parts = message.text.split()
    lang = user_lang.get(message.from_user.id, "en")
    if len(parts)!=2 or not parts[1].isdigit():
        await message.answer("Usage: /map <event_id>" if lang=="en" else "/map <event_id> ይጠቀሙ")
        return
    event_id = int(parts[1])
    conn = sqlite3.connect("db.sqlite")
    cursor = conn.cursor()
    cursor.execute("SELECT gps_lat,gps_long FROM events WHERE id=?", (event_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        lat, lon = row
        map_url = f"https://www.google.com/maps/search/?api=1&query={lat},{lon}"
        await message.answer(f"Map location: {map_url}" if lang=="en" else f"ቦታ: {map_url}")
    else:
        await message.answer("Event not found." if lang=="en" else "ኢቨንት አልተገኘም።")

if __name__=="__main__":
    executor.start_polling(dp, skip_updates=True)